# 记录

## 说明

- 这个项目作为webpack多文件打包使用，用于微型项目，如广告推广页面、简单投票页面等。
- 简单页面使用大型MVVM框架会导致打包体积过大。
- [开发进度日志](#开发进度日志)记录当前开发的功能与目前想法
- [任务列表](#任务列表)记录准备开发的功能
- [目录约定](#目录约定)

## 开发进度日志

- `2019-12-10 09:17`: 配置入口文件解析，测试项目能否启动
- `2019-12-10 09:25`: 取消热更新分步打包，避免不停重启
- `2019-12-10 17:26`: 加入了`mini-css-extract-plugin`插件，将css文件单独摘出。
- `2019-12-10 17:29`: 引入utils文件夹
- `2019-12-10 17:30`: 接下来尝试分包
- `2019-12-11 10:54`: 昨晚尝试打包文件时发现图片资源文件未能正常引用，无奈临时换用parcel处理，今天看一下是否会复现
- `2019-12-11 10:55`: 打包放到服务器后发现资源路径正常，可能是配置问题，接下来根据任务列表开发
- `2019-12-11 12:42`: 更新`html-webpack-loader`至beta版本可以自动将`splitChunks`分包后的文件引入到html文件中
- `2019-12-11 12:43`: 通过设置`filename`使得公共js文件存储为指定格式的文件，属性名为文件夹名称
- `2019-12-11 12:47`: 后续打算自动化webpack打包`pages`文件夹里面的文件，使用html开发所以打算依据`.html`自动化路由，暂时先用配置文件替代，拟用一个数组来导入`entry`和`htmlWebpackPlugin`配置
- `2019-12-11 14:42`: 试了一下html页面也可以直接引用js，不用像之前那样js创建`script`标签再引入
- `2019-12-11 17:18`: css已经提取到公共文件，但是同时发现了一个问题，不知道什么原因，之前可以加载的图片路径现在又加载不到了，build之后不受影响，devserver文件路径错误
- `2019-12-11 17:30`: 发现原因了，是http路径问题`http://127.0.0.1:8080/home`后面加上`/`则访问不到图片
- `2019-12-12 14:42`: 使用src下面的`router.js`来控制路由显示
- `2019-12-12 16:47`: 使用`nodemon`监控配置文件更改来自动重启应用，更改dev-server配置用来监听html文件变化重载页面
- `2019-12-12 16:54`: 本来想对css也进行分包处理，但是实际工程没有遇到过同一工程采用截然不同的基础样式库的情况，所以暂时不做
- `2019-12-12 16:55`: 接下来对图片进行处理，理想是公共图片如logo、fav等可以复用的打包到固定的文件夹中，项目内的图片打包到项目中
- `2019-12-12 17:19`: 暂时先统一放到images里面，具体配置尚未处理
- `2019-12-13 09:09`: dev的时候不需要用到`cleanWebpackPlugin`，将其移入`webpack.prod.js`中加快开发编译速度
- `2019-12-13 10:25`: 图片根据路径分别进行处理
- `2019-12-13 10:45`: 经过测试发现`htmlWebpackPlugin`可以不引入任何chunks，但是带来的是不能引入css文件并且dev模式下hmr失效
- `2019-12-13 11:01`: 实际操作之后，综合考虑一下，决定规定`.html`文件必须配套一个`.js`文件处理，之后使用parcel可以考虑不需要配置`.js`文件，webpack用于打包js文件所以强制要求了
- `2019-12-13 13:14`: window和linux的图片路径统一使用`path.sep`进行正则拼接处理
- `2019-12-18 13:48`: 14、15号是周末，16、17刚搬家，耽搁了一下，现在继续进行自动编译的处理工作。规定html文件使用`htmlWebpackPlugin`打包，并配套相应的js文件，js文件不单独打包，由其他js文件引入使用
- `2019-12-18 17:58`: 虽然成功加载到`pages`下的文件并且写入了对象中，但是由于是异步的所以只能加载`entry`而无法加载`htmlWebpackPlugin`，所以打算将其换成同步读取文件
- `2019-12-18 18:12`: 改用同步方法配置webpack，完成`pages`下目录自动编译
- `2019-12-18 18:13`: 发现个问题，自动编译的时候`libs`文件夹下的css文件会更换本地源位置，暂未定位问题，待解决
- `2019-12-18 18:24`: 又发现一个问题，js引入ts文件报错`module not found`
- `2019-12-18 18:30`: js引入ts报错的解决方法是，js和ts文件分别使用不同的loader处理
- `2019-12-18 18:31`: css文件问题是我不了解vscode的显是逻辑，没有错误
- `2019-12-18 18:32`: 现在框架已经基本完成，下一步是使用layout布局
- `2019-12-18 18:43`: css文件应该在js文件内引入
- `2019-12-18 19:32`: `html-loader`配置项改为`html-loader?interpolate`进入字符串插值模式，引用方法为`${require('./info/index.html')}`
- `2019-12-19 10:05`: 刚刚读umi文档发现了`umi-plugin-mpa`插件，里面的方法非常好，决定先去使用一下，看一下他对应的打包方法，同是按照他所规定的，不打包`__`和`.`开头的文件夹
- `2019-12-19 10:29`: 暂停mock数据、单元测试等功能开发，观摩下umi-plugin-mpa的用法，然后回来继续完善相应功能
- `2019-12-19 15:30`: 根据`umi-plugin-mpa`文档进行了开发使用，记录体验感受
- `2019-12-20 09:09`: 思考了一下，虽然`umi-plugin-mpa`足够使用，但是本项目不会停止开发，目标是完成基础功能，包含一个工程应有的分包、测试、模拟数据等，虽然兼容性可能没有`umi`好，但是可以作为小型项目的基础研发配置，项目配置会参考`umi`的`umi-test`、`umi-mock`等优秀插件
- `2019-12-20 09:19`: 现在项目启动偶尔会报权限错误，解决办法是重启即可，已排查到是`clean-webpack-plugin`的问题，再出错的话考虑使用多任务，用`rimraf`代替
- `2019-12-23 09:48`: `umi-mock`使用的是`express`的middleware功能，本项目没有使用`express`所以考虑其他的实现方法
- `2019-12-23 10:44`: 引入`mocker-api`实现webpack的mock功能，`umi-mock`规定`_mcok`文件和`mock`文件夹下文件为mock文件，本项目只取用`mock`文件夹下文件为mock文件，因为大多数情况下不需要单独的`_mock.js`文件去处理，而且过于分散有可能会产生相同的配置进而影响开发
- `2019-12-23 10:46`: 新增[目录约定](#目录约定)功能，规范开发
- `2019-12-23 12:26`: `index.html`获取不到base路径需要单独处理
- `2019-12-23 15:11`: 加入单元测试功能，使用`mocha`作为测试库，`power-assert`作为断言库，`intelli-espower-loader`作为js文件额外信息打印，`espower-typescript/guess`作为ts额外信息打印
- `2019-12-23 15:37`: 更新`mocha`script配置，监听test和src文件夹下的`.test.[jt]s`文件
- `2019-12-24 09:37`: 找了layout的代码，但是现在有些犹豫要不要上layout，规则是什么，`umi`的规则是`layout`文件夹下`index.js`和`_layout.js`文件作为layout，本项目考虑配置式layout，因为多页页面可能不是需要很多种布局，可能就一个logo、favicon和copyright不会变
- `2019-12-24 10:21`: 配置文件和项目文件写法不一致挺别扭的，打算用`@babel/register`注册一下
- `2019-12-24 13:25`: 项目改用`typescript`管理

## 任务列表

- [x] 配置同步
- [x] 提出公共js文件，lib文件
- [x] 提出公共css文件
- [x] 配置式打包文件`webpack.common.js`，避免增加一个文件夹手动加上很多代码
- [x] 使用自动化工具编译
- [x] 图片路径处理
- [x] `pages`路径下自动编译
- [x] html文件复用，引入
- [x] mock数据
- [x] 单元测试
- [x] `typescript`管理项目
- [ ] layout布局

## 目录约定

一个复杂应用的结构目录如下

``` (text)
.
├── dist/                          // 默认的 build 输出目录
├── mock/                          // mock 文件所在目录，基于 mocker-api
├── config/                        // webpack配置
└── src/                           // 源码目录，可选
    ├── pages/                     // 页面目录，里面的文件即路由
        ├── 404.html                 // 404 页面
        ├── page1.js               // 页面 1，任意命名，导出 html 页面
        ├── page1.test.js          // 用例文件，umi test 会匹配所有 .test.js 结尾的文件
        └── page2.js               // 页面 2，任意命名
└── test/                           // 源码目录，可选
    ├── test1.test.js          // 用例文件
└── package.json
```

## `umi-plugin-mpa`使用感受

- 优点
  1. 配置轻量化，仅需三行代码即可以开始开发
  2. 支持mock数据，在`mock`文件夹下或`_mock.js`文件中书写mockjs代码即可
  3. 支持单元测试，`test`文件夹下文件和`.test.js`文件自动加入测试项目
  4. 无需配置即支持ejs模板开发，默认加载`.ejs`文件，路径不存在则使用`.tsx|.ts|.jsx|.js`文件，无需手动配置
  5. 支持`webpack`的配置功能，可以自定义`html-webpack-plugin`的配置实现本项目代码的功能，同时也可以无配置自动加载`pages`文件夹下页面生成html文件
  6. 库文件复用，`libs`文件提取公共包裹
  7. 支持`alias`路径别名功能

- 缺点
  1. 打包文件相对于基础功能压缩来讲偏大
  2. less文件自动加上区块名称，对于多页面文件作用不大
